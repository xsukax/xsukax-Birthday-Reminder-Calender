<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>xsukax Birthday Reminder Calendar</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- Header -->
        <header class="mb-8">
            <h1 class="text-3xl font-semibold text-gray-900 mb-2">xsukax Birthday Reminder Calender</h1>
            <p class="text-gray-600">Never miss a birthday again</p>
        </header>

        <!-- Countdown Section -->
        <div class="bg-white border border-gray-200 rounded-lg p-6 mb-6 shadow-sm">
            <h2 class="text-lg font-semibold text-gray-900 mb-3">Next Birthday</h2>
            <div id="countdown" class="text-center py-4">
                <p class="text-gray-500">Add birthdays to see countdown</p>
            </div>
        </div>

        <!-- Add Birthday Form -->
        <div class="bg-white border border-gray-200 rounded-lg p-6 mb-6 shadow-sm">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">Add Birthday</h2>
            <form id="addBirthdayForm" class="flex flex-col sm:flex-row gap-3">
                <input type="text" id="nameInput" placeholder="Name" required
                    class="flex-1 px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <div class="flex-1 relative">
                    <input type="text" id="dateInput" placeholder="ddmmyyyy" maxlength="10" required
                        class="w-full px-4 py-2 pr-12 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <button type="button" id="datePickerBtn"
                        class="absolute right-2 top-1/2 transform -translate-y-1/2 p-2 text-gray-500 hover:text-gray-700 focus:outline-none">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                    </button>
                    <input type="date" id="hiddenDatePicker" class="hidden">
                </div>
                <button type="submit"
                    class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors">
                    Add Birthday
                </button>
            </form>
            <p class="text-xs text-gray-500 mt-2">Type date as ddmmyyyy (e.g., 25121990) or click the calendar icon</p>
        </div>

        <!-- Birthday List -->
        <div class="bg-white border border-gray-200 rounded-lg shadow-sm">
            <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                <h2 class="text-lg font-semibold text-gray-900">Birthdays</h2>
                <div class="flex gap-2">
                    <button id="importBtn"
                        class="px-4 py-2 text-sm border border-gray-300 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
                        Import
                    </button>
                    <button id="exportBtn"
                        class="px-4 py-2 text-sm border border-gray-300 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
                        Export
                    </button>
                </div>
            </div>
            <div id="birthdayList" class="divide-y divide-gray-200">
                <div class="p-6 text-center text-gray-500">
                    No birthdays added yet
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-2">Confirm Delete</h3>
                <p class="text-gray-600 mb-6">Are you sure you want to delete this birthday? This action cannot be undone.</p>
                <div class="flex gap-3 justify-end">
                    <button id="cancelDelete"
                        class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
                        Cancel
                    </button>
                    <button id="confirmDelete"
                        class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 transition-colors">
                        Delete
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Import Modal -->
    <div id="importModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Import Birthdays</h3>
                <p class="text-gray-600 text-sm mb-4">Select an encoded JSON file to import your birthdays</p>
                <input type="file" id="importFile" accept=".json"
                    class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4">
                <div class="flex gap-3 justify-end">
                    <button id="cancelImport"
                        class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
                        Cancel
                    </button>
                    <button id="confirmImport"
                        class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
                        Import
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="hidden fixed bottom-4 right-4 bg-gray-900 text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-opacity">
        <p id="toastMessage"></p>
    </div>

    <script>
        let birthdays = [];
        let deleteTarget = null;

        // Encoding and Decoding Functions
        function encodeData(data) {
            const jsonString = JSON.stringify(data);
            const encoded = btoa(unescape(encodeURIComponent(jsonString)));
            return encoded;
        }

        function decodeData(encodedData) {
            try {
                const decoded = decodeURIComponent(escape(atob(encodedData)));
                return JSON.parse(decoded);
            } catch (e) {
                throw new Error('Invalid encoded data');
            }
        }

        // LocalStorage Functions
        function saveToLocalStorage() {
            const encoded = encodeData(birthdays);
            localStorage.setItem('birthdays', encoded);
        }

        function loadFromLocalStorage() {
            const stored = localStorage.getItem('birthdays');
            if (stored) {
                try {
                    birthdays = decodeData(stored);
                } catch (e) {
                    console.error('Error loading from localStorage:', e);
                    birthdays = [];
                }
            }
        }

        // Date Parsing and Validation Functions
        function parseDateDDMMYYYY(dateString) {
            // Remove any non-digit characters
            const cleanDate = dateString.replace(/\D/g, '');
            
            if (cleanDate.length !== 8) {
                return null;
            }
            
            const day = parseInt(cleanDate.substring(0, 2), 10);
            const month = parseInt(cleanDate.substring(2, 4), 10);
            const year = parseInt(cleanDate.substring(4, 8), 10);
            
            if (isNaN(day) || isNaN(month) || isNaN(year)) {
                return null;
            }
            
            if (month < 1 || month > 12) {
                return null;
            }
            
            if (day < 1 || day > 31) {
                return null;
            }
            
            if (year < 1900 || year > 2100) {
                return null;
            }
            
            const date = new Date(year, month - 1, day);
            
            if (date.getDate() !== day || date.getMonth() !== month - 1 || date.getFullYear() !== year) {
                return null;
            }
            
            return date;
        }

        function formatDateDDMMYYYY(date) {
            const d = new Date(date);
            const day = String(d.getDate()).padStart(2, '0');
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const year = d.getFullYear();
            return `${day}/${month}/${year}`;
        }

        function autoFormatDateInput(value) {
            // Remove all non-digit characters
            const cleaned = value.replace(/\D/g, '');
            
            let formatted = '';
            for (let i = 0; i < cleaned.length && i < 8; i++) {
                if (i === 2 || i === 4) {
                    formatted += '/';
                }
                formatted += cleaned[i];
            }
            
            return formatted;
        }

        function convertDatePickerToDisplay(isoDate) {
            const date = new Date(isoDate);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        function convertDisplayToDatePicker(displayDate) {
            const cleaned = displayDate.replace(/\D/g, '');
            if (cleaned.length !== 8) return '';
            
            const day = cleaned.substring(0, 2);
            const month = cleaned.substring(2, 4);
            const year = cleaned.substring(4, 8);
            
            return `${year}-${month}-${day}`;
        }

        // UI Functions
        function showToast(message) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            toastMessage.textContent = message;
            toast.classList.remove('hidden');
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        function showModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
        }

        function hideModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        // Date Calculation Functions
        function calculateDaysUntil(birthDate) {
            const today = new Date();
            const currentYear = today.getFullYear();
            const birth = new Date(birthDate);
            
            let nextBirthday = new Date(currentYear, birth.getMonth(), birth.getDate());
            
            if (nextBirthday < today) {
                nextBirthday = new Date(currentYear + 1, birth.getMonth(), birth.getDate());
            }
            
            const diffTime = nextBirthday - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            return { days: diffDays, date: nextBirthday };
        }

        function calculateAge(birthDate) {
            const today = new Date();
            const birth = new Date(birthDate);
            let age = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                age--;
            }
            
            return age;
        }

        function formatDateForDisplay(date) {
            const d = new Date(date);
            const day = d.getDate();
            const month = d.toLocaleDateString('en-US', { month: 'long' });
            return `${day} ${month}`;
        }

        // Display Functions
        function updateCountdown() {
            const countdownDiv = document.getElementById('countdown');
            
            if (birthdays.length === 0) {
                countdownDiv.innerHTML = '<p class="text-gray-500">Add birthdays to see countdown</p>';
                return;
            }
            
            const sorted = [...birthdays].sort((a, b) => {
                return calculateDaysUntil(a.date).days - calculateDaysUntil(b.date).days;
            });
            
            const next = sorted[0];
            const { days, date } = calculateDaysUntil(next.date);
            const age = calculateAge(next.date) + 1;
            
            countdownDiv.innerHTML = `
                <div>
                    <p class="text-2xl font-semibold text-gray-900 mb-1">${next.name}</p>
                    <p class="text-gray-600 mb-2">${formatDateForDisplay(date)} · Turning ${age}</p>
                    <p class="text-3xl font-bold text-blue-600">${days} ${days === 1 ? 'day' : 'days'}</p>
                </div>
            `;
        }

        function renderBirthdays() {
            const listDiv = document.getElementById('birthdayList');
            
            if (birthdays.length === 0) {
                listDiv.innerHTML = '<div class="p-6 text-center text-gray-500">No birthdays added yet</div>';
                return;
            }
            
            const sorted = [...birthdays].sort((a, b) => {
                return calculateDaysUntil(a.date).days - calculateDaysUntil(b.date).days;
            });
            
            listDiv.innerHTML = sorted.map((birthday, index) => {
                const { days } = calculateDaysUntil(birthday.date);
                const age = calculateAge(birthday.date) + 1;
                const displayDate = formatDateDDMMYYYY(birthday.date);
                
                return `
                    <div class="p-4 flex justify-between items-center hover:bg-gray-50 transition-colors">
                        <div>
                            <p class="font-medium text-gray-900">${birthday.name}</p>
                            <p class="text-sm text-gray-600">${displayDate} · Turning ${age}</p>
                        </div>
                        <div class="flex items-center gap-4">
                            <span class="text-sm font-medium text-blue-600">${days} ${days === 1 ? 'day' : 'days'}</span>
                            <button onclick="deleteBirthday(${index})"
                                class="text-red-600 hover:text-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 rounded px-2 py-1">
                                Delete
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            updateCountdown();
        }

        // CRUD Functions
        function addBirthday(name, dateString) {
            const parsedDate = parseDateDDMMYYYY(dateString);
            
            if (!parsedDate) {
                showToast('Invalid date. Use format: ddmmyyyy');
                return false;
            }
            
            birthdays.push({ 
                name, 
                date: parsedDate.toISOString()
            });
            saveToLocalStorage();
            renderBirthdays();
            showToast('Birthday added successfully');
            return true;
        }

        function deleteBirthday(index) {
            deleteTarget = index;
            showModal('deleteModal');
        }

        function confirmDeleteBirthday() {
            if (deleteTarget !== null) {
                const sorted = [...birthdays].sort((a, b) => {
                    return calculateDaysUntil(a.date).days - calculateDaysUntil(b.date).days;
                });
                const birthdayToDelete = sorted[deleteTarget];
                const originalIndex = birthdays.findIndex(b => b.name === birthdayToDelete.name && b.date === birthdayToDelete.date);
                
                birthdays.splice(originalIndex, 1);
                saveToLocalStorage();
                renderBirthdays();
                showToast('Birthday deleted');
                deleteTarget = null;
            }
            hideModal('deleteModal');
        }

        // Import/Export Functions
        function exportData() {
            const encoded = encodeData(birthdays);
            const blob = new Blob([encoded], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'birthdays-encoded.json';
            a.click();
            URL.revokeObjectURL(url);
            showToast('Birthdays exported successfully');
        }

        function importData() {
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showToast('Please select a file');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const encodedData = e.target.result;
                    const imported = decodeData(encodedData);
                    
                    if (Array.isArray(imported)) {
                        birthdays = imported;
                        saveToLocalStorage();
                        renderBirthdays();
                        showToast('Birthdays imported successfully');
                        hideModal('importModal');
                        fileInput.value = '';
                    } else {
                        showToast('Invalid data format');
                    }
                } catch (error) {
                    showToast('Error: Unable to decode file');
                }
            };
            reader.readAsText(file);
        }

        // Event Listeners
        const dateInput = document.getElementById('dateInput');
        const hiddenDatePicker = document.getElementById('hiddenDatePicker');
        const datePickerBtn = document.getElementById('datePickerBtn');

        // Auto-format date input as user types
        dateInput.addEventListener('input', (e) => {
            const cursorPosition = e.target.selectionStart;
            const oldValue = e.target.value;
            const newValue = autoFormatDateInput(oldValue);
            
            e.target.value = newValue;
            
            // Adjust cursor position after formatting
            if (newValue.length > oldValue.length && (newValue[cursorPosition - 1] === '/')) {
                e.target.setSelectionRange(cursorPosition + 1, cursorPosition + 1);
            }
        });

        // Date picker button click
        datePickerBtn.addEventListener('click', () => {
            hiddenDatePicker.showPicker();
        });

        // When date is selected from picker
        hiddenDatePicker.addEventListener('change', (e) => {
            const selectedDate = e.target.value;
            if (selectedDate) {
                dateInput.value = convertDatePickerToDisplay(selectedDate);
            }
        });

        document.getElementById('addBirthdayForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('nameInput').value.trim();
            const date = document.getElementById('dateInput').value.trim();
            
            if (name && date) {
                const success = addBirthday(name, date);
                if (success) {
                    document.getElementById('nameInput').value = '';
                    document.getElementById('dateInput').value = '';
                }
            }
        });

        document.getElementById('exportBtn').addEventListener('click', exportData);
        document.getElementById('importBtn').addEventListener('click', () => showModal('importModal'));

        document.getElementById('cancelDelete').addEventListener('click', () => {
            hideModal('deleteModal');
            deleteTarget = null;
        });

        document.getElementById('confirmDelete').addEventListener('click', confirmDeleteBirthday);

        document.getElementById('cancelImport').addEventListener('click', () => {
            hideModal('importModal');
            document.getElementById('importFile').value = '';
        });

        document.getElementById('confirmImport').addEventListener('click', importData);

        // Close modals on outside click
        document.getElementById('deleteModal').addEventListener('click', (e) => {
            if (e.target.id === 'deleteModal') {
                hideModal('deleteModal');
                deleteTarget = null;
            }
        });

        document.getElementById('importModal').addEventListener('click', (e) => {
            if (e.target.id === 'importModal') {
                hideModal('importModal');
                document.getElementById('importFile').value = '';
            }
        });

        // Initialize Application
        loadFromLocalStorage();
        renderBirthdays();
    </script>
</body>
</html>